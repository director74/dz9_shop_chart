# Shop Helm Chart

Данный Helm чарт развертывает микросервисную архитектуру интернет-магазина.

Чарт включает необходимую инфраструктуру:
- PostgreSQL (для хранения данных)
- RabbitMQ (для асинхронного обмена сообщениями и реализации саги)
- Mailhog (для эмуляции SMTP сервера и просмотра отправленных email)

## Требования

- Kubernetes 1.19+
- Helm 3.2.0+
- Настроенный Ingress Controller (NGINX)
- Доступ к реестру Docker образов, содержащему образы сервисов

## Установка

1. Клонируйте репозиторий с чартом:
```bash
git clone https://github.com/director74/dz9_shop_chart
cd dz9_shop_chart
```

2. Установите чарт:
```bash
helm install shop ./
```

Примечание: Namespace "dz9" будет создан автоматически при использовании флага --create-namespace. Если вы хотите использовать другой namespace, укажите его в параметре values.yaml (global.namespace) и в команде установки.

## Настройка

Конфигурация чарта осуществляется через файл `values.yaml`. Основные параметры:

- `global.namespace` - Namespace для установки всех ресурсов
- `global.ingress` - Настройки Ingress
- `global.jwt` - Настройки JWT для авторизации между сервисами
- `global.postgresql` - Общие настройки PostgreSQL
- `global.rabbitmq` - Общие настройки RabbitMQ

Каждый сервис имеет свои параметры конфигурации:
- `order`, `billing`, `payment`, `warehouse`, `delivery`, `notification` - Настройки соответствующих сервисов
- `postgres`, `rabbitmq`, `mailhog` - Настройки инфраструктуры

## Доступ к сервисам

### API Endpoints

- Order Service API: http://arch.homework/api/v1/orders, http://arch.homework/api/v1/auth, ...
- Billing Service API: http://arch.homework/api/v1/billing, http://arch.homework/api/v1/accounts, ...
- Payment Service API: http://arch.homework/api/v1/payments, ...
- Warehouse Service API: http://arch.homework/api/v1/warehouse, ...
- Delivery Service API: http://arch.homework/api/v1/delivery, ...
- Notification Service API: http://arch.homework/api/v1/notifications, ...

### Интерфейсы управления

- RabbitMQ Management UI: http://arch.homework/rabbitmq/
  - Логин/пароль: значения из `global.rabbitmq.auth.username`/`global.rabbitmq.auth.password` (по умолчанию: guest/guest)

- Mailhog UI (просмотр отправленных писем): http://arch.homework/mailhog/
  - Не требует аутентификации

## Миграции баз данных

Миграции баз данных выполняются автоматически при установке или обновлении чарта через Kubernetes Jobs.

## Архитектура JWT аутентификации

В системе реализован единый механизм аутентификации:
- Все сервисы используют общий ключ подписи JWT (JWT_SIGNING_KEY)
- Общие настройки для JWT_TOKEN_ISSUER и JWT_TOKEN_AUDIENCES
- Токен, выданный одним сервисом, принимается всеми другими сервисами
- Передача токена между сервисами происходит в заголовке Authorization
- Пользователю достаточно один раз пройти аутентификацию для доступа ко всем сервисам

## Идемпотентность при создании заказов

Система обеспечивает идемпотентность операций создания заказов с использованием заголовка `X-Idempotency-Key`:

- **Механизм работы**:
  - Клиент отправляет запрос на создание заказа с уникальным идентификатором в заголовке `X-Idempotency-Key`
  - Сервис заказов сохраняет этот идентификатор вместе с созданным заказом
  - При повторном запросе с тем же идентификатором система не создает новый заказ, а возвращает данные ранее созданного
  - Запросы без заголовка `X-Idempotency-Key` отклоняются с ошибкой 400 Bad Request

- **Преимущества**:
  - Защита от дублирования заказов при потере сетевого соединения
  - Безопасное повторение запросов клиентом без риска создания дубликатов
  - Устойчивость к временным сбоям сети между сервисами

### Компоненты системы

Система состоит из следующих компонентов:
- Микросервисы (Order, Billing, Payment, Warehouse, Delivery, Notification)
- База данных PostgreSQL с отдельными схемами для каждого сервиса
- Очереди сообщений RabbitMQ для асинхронного взаимодействия
- Ingress для маршрутизации внешних запросов

Коммуникация между сервисами происходит через:
1. Синхронные REST API вызовы (с JWT-авторизацией)
2. Асинхронное взаимодействие через очереди сообщений RabbitMQ

## Тестирование

Для тестирования API предоставляются Postman коллекции:
- Коллекция для тестирования идемпотентности: `/tests/dz9/idempotency_test_collection.json`

### Запуск автотестов с помощью Newman

```bash
newman run "tests/dz9/dz9_postman_collection.json" -e tests/dz9/k8s-environment.json
```

Тесты проверяют следующие сценарии:

**Тесты идемпотентности:**
- Создание заказа с уникальным идентификатором запроса
- Повторная отправка запроса с тем же идентификатором
- Создание заказа с новым идентификатором
- Отправка запроса без идентификатора (проверка обработки ошибки)
- Проверка информации о созданных заказах
- Проверка целостности данных между повторными запросами

## Документация

### API Спецификация (Swagger)

Полную спецификацию API можно найти в файле [swagger.yaml](docs/dz9/swagger.yaml).